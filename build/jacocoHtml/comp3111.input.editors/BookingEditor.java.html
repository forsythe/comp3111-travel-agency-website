<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">website</a> &gt; <a href="index.source.html" class="el_package">comp3111.input.editors</a> &gt; <span class="el_source">BookingEditor.java</span></div><h1>BookingEditor.java</h1><pre class="source lang-java linenums">package comp3111.input.editors;

import java.time.Instant;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;

import comp3111.data.model.PromoEvent;
import comp3111.data.repo.PromoEventRepository;
import comp3111.input.exceptions.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import com.vaadin.data.Binder;
import com.vaadin.data.BinderValidationStatus;
import com.vaadin.data.provider.ListDataProvider;
import com.vaadin.server.Page;
import com.vaadin.spring.annotation.SpringComponent;
import com.vaadin.spring.annotation.UIScope;
import com.vaadin.ui.Button;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.FormLayout;
import com.vaadin.ui.Grid;
import com.vaadin.ui.Grid.Column;
import com.vaadin.ui.Grid.SelectionMode;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.components.grid.HeaderCell;
import com.vaadin.ui.components.grid.HeaderRow;

import comp3111.Utils;
import comp3111.data.DBManager;
import comp3111.data.GridCol;
import comp3111.data.model.Booking;
import comp3111.data.model.Customer;
import comp3111.data.model.Offering;
import comp3111.data.repo.BookingRepository;
import comp3111.data.repo.CustomerRepository;
import comp3111.data.repo.OfferingRepository;
import comp3111.input.converters.ConverterFactory;
import comp3111.input.validators.ValidatorFactory;
import comp3111.view.NotificationFactory;

/**
 * Represents the booking editor in the Booking management view
 * 
 * @author Forsythe
 *
 */
@SuppressWarnings(&quot;serial&quot;)
@SpringComponent
@UIScope
public class BookingEditor extends VerticalLayout {
<span class="fc" id="L60">	private static final Logger log = LoggerFactory.getLogger(BookingEditor.class);</span>

<span class="fc" id="L62">	private Grid&lt;Booking&gt; bookingGrid = new Grid&lt;&gt;(Booking.class);</span>

	private Booking selectedBookingRecord;

	private BookingRepository bookingRepo;
	private CustomerRepository customerRepo;
	private OfferingRepository offeringRepo;
	private PromoEventRepository promoRepo;
	private DBManager dbManager;

	// the fields in the subwindow
	private ComboBox&lt;Customer&gt; customer;
	private ComboBox&lt;Offering&gt; offering;
	private TextField numberAdults;
	private TextField numberChildren;
	private TextField numberToddlers;
	private TextField amountPaid;
	private TextField specialRequest;
	private ComboBox&lt;String&gt; paymentStatus;
	private ComboBox&lt;String&gt; promoCode;
	private Button confirmButton;
	private BinderValidationStatus&lt;Booking&gt; validationStatus;

<span class="fc" id="L85">	private final HashMap&lt;String, ProviderAndPredicate&lt;?, ?&gt;&gt; gridFilters = new HashMap&lt;String, ProviderAndPredicate&lt;?, ?&gt;&gt;();</span>

	/**
	 * Constructs the booking editor for creating/editing Bookings
	 * 
	 * @param br
	 *            The BookingRepository
	 * @param cr
	 *            The CustomerRepository
	 * @param or
	 *            The OfferingRepository
	 * @param per
	 *            The PromoEventRepository
	 * @param dbm
	 *            The DBManager
	 */
	@Autowired
	public BookingEditor(BookingRepository br, CustomerRepository cr, OfferingRepository or, PromoEventRepository per,
<span class="fc" id="L103">			DBManager dbm) {</span>
<span class="fc" id="L104">		this.bookingRepo = br;</span>
<span class="fc" id="L105">		this.customerRepo = cr;</span>
<span class="fc" id="L106">		this.offeringRepo = or;</span>
<span class="fc" id="L107">		this.promoRepo = per;</span>
<span class="fc" id="L108">		this.dbManager = dbm;</span>

<span class="fc" id="L110">		Button createBookingButton = new Button(&quot;Create new booking&quot;);</span>
<span class="fc" id="L111">		Button editBookingButton = new Button(&quot;Edit booking&quot;);</span>

<span class="fc" id="L113">		HorizontalLayout rowOfButtons = new HorizontalLayout();</span>
<span class="fc" id="L114">		rowOfButtons.addComponent(createBookingButton);</span>
<span class="fc" id="L115">		rowOfButtons.addComponent(editBookingButton);</span>

		// disable edit
<span class="fc" id="L118">		editBookingButton.setEnabled(false);</span>

		// add component to view
<span class="fc" id="L121">		this.addComponent(rowOfButtons);</span>

		// get from GridCol
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		if (bookingRepo.findAll() != null) // can be null if mockito</span>
<span class="nc" id="L125">			bookingGrid.setItems(Utils.iterableToCollection(bookingRepo.findAll()).stream()</span>
<span class="nc" id="L126">					.sorted((b1, b2) -&gt; b1.getId().compareTo(b2.getId())));</span>

<span class="fc" id="L128">		bookingGrid.setWidth(&quot;100%&quot;);</span>
<span class="fc" id="L129">		bookingGrid.setSelectionMode(SelectionMode.SINGLE);</span>

<span class="fc" id="L131">		bookingGrid.addSelectionListener(event -&gt; {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (event.getFirstSelectedItem().isPresent()) {</span>
<span class="nc" id="L133">				selectedBookingRecord = event.getFirstSelectedItem().get();</span>
<span class="nc" id="L134">				editBookingButton.setEnabled(true);</span>
<span class="nc" id="L135">				createBookingButton.setEnabled(false);</span>
			} else {
<span class="nc" id="L137">				selectedBookingRecord = null;</span>
<span class="nc" id="L138">				editBookingButton.setEnabled(false);</span>
<span class="nc" id="L139">				createBookingButton.setEnabled(true);</span>
			}
<span class="nc" id="L141">		});</span>

<span class="fc" id="L143">		bookingGrid.removeColumn(GridCol.BOOKING_CUSTOMER);</span>
<span class="fc" id="L144">		bookingGrid.removeColumn(GridCol.BOOKING_ID);</span>
<span class="fc" id="L145">		bookingGrid.removeColumn(GridCol.BOOKING_PROMO_DISCOUNT_MULTIPLIER);</span>
<span class="fc" id="L146">		bookingGrid.removeColumn(GridCol.BOOKING_TOTAL_NUMBER_OF_PEOPLE);</span>
<span class="fc" id="L147">		bookingGrid.removeColumn(GridCol.BOOKING_PROMO_CODE_USED);</span>

<span class="fc" id="L149">		bookingGrid.setColumnOrder(GridCol.BOOKING_CUSTOMER_HKID, GridCol.BOOKING_CUSTOMER_NAME,</span>
				GridCol.BOOKING_OFFERING, GridCol.BOOKING_NUM_ADULTS, GridCol.BOOKING_NUM_CHILDREN,
				GridCol.BOOKING_NUM_TODDLERS, GridCol.BOOKING_TOUR_ID, GridCol.BOOKING_TOUR_NAME,
				GridCol.BOOKING_AMOUNT_PAID, GridCol.BOOKING_TOTAL_COST, GridCol.BOOKING_SPECIAL_REQUEST,
				GridCol.BOOKING_PAYMENT_STATUS);

<span class="fc" id="L155">		bookingGrid.addColumn(b -&gt; {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			if (b.getPromoDiscountMultiplier() != 1) {</span>
<span class="nc" id="L157">				return String.valueOf(b.getPromoDiscountMultiplier());</span>
			} else {
<span class="nc" id="L159">				return &quot;none&quot;;</span>
			}
<span class="fc" id="L161">		}).setId(GridCol.BOOKING_PROMO_DISCOUNT_MULTIPLIER_MASKED).setCaption(&quot;Promotional Discount&quot;);</span>

<span class="fc" id="L163">		HeaderRow filterRow = bookingGrid.appendHeaderRow();</span>

<span class="fc bfc" id="L165" title="All 2 branches covered.">		for (Column&lt;Booking, ?&gt; col : bookingGrid.getColumns()) {</span>
<span class="fc" id="L166">			col.setMinimumWidth(120);</span>
<span class="fc" id="L167">			col.setHidable(true);</span>
<span class="fc" id="L168">			col.setHidingToggleCaption(col.getCaption());</span>
<span class="fc" id="L169">			col.setExpandRatio(1);</span>
<span class="fc" id="L170">			HeaderCell cell = filterRow.getCell(col.getId());</span>

			// Have an input field to use for filter
<span class="fc" id="L173">			TextField filterField = new TextField();</span>
<span class="fc" id="L174">			filterField.setWidth(130, Unit.PIXELS);</span>
<span class="fc" id="L175">			filterField.setHeight(30, Unit.PIXELS);</span>

<span class="fc" id="L177">			filterField.addValueChangeListener(change -&gt; {</span>
<span class="nc" id="L178">				String searchVal = change.getValue();</span>
<span class="nc" id="L179">				String colId = col.getId();</span>

<span class="nc" id="L181">				log.info(&quot;Value change in col [{}], val=[{}]&quot;, colId, searchVal);</span>
<span class="nc" id="L182">				ListDataProvider&lt;Booking&gt; dataProvider = (ListDataProvider&lt;Booking&gt;) bookingGrid.getDataProvider();</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">				if (!filterField.isEmpty()) {</span>
					try {
<span class="nc" id="L186">						gridFilters.put(colId, FilterFactory.getFilterForBooking(colId, searchVal));</span>
<span class="nc" id="L187">						log.info(&quot;updated filter on attribute [{}]&quot;, colId);</span>

<span class="nc" id="L189">					} catch (Exception e) {</span>
<span class="nc" id="L190">						log.info(&quot;ignoring val=[{}], col=[{}] is invalid&quot;, searchVal, colId);</span>
<span class="nc" id="L191">					}</span>
				} else {
<span class="nc" id="L193">					gridFilters.remove(colId);</span>
<span class="nc" id="L194">					log.info(&quot;removed filter on attribute [{}]&quot;, colId);</span>

				}
<span class="nc" id="L197">				dataProvider.clearFilters();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">				for (String colFilter : gridFilters.keySet()) {</span>
<span class="nc" id="L199">					ProviderAndPredicate paf = gridFilters.get(colFilter);</span>
<span class="nc" id="L200">					dataProvider.addFilter(paf.provider, paf.predicate);</span>
<span class="nc" id="L201">				}</span>
<span class="nc" id="L202">				dataProvider.refreshAll();</span>
<span class="nc" id="L203">			});</span>
<span class="fc" id="L204">			cell.setComponent(filterField);</span>

<span class="fc" id="L206">		}</span>

<span class="fc" id="L208">		this.addComponent(bookingGrid);</span>

<span class="fc" id="L210">		createBookingButton.addClickListener(event -&gt; {</span>
<span class="nc" id="L211">			getUI();</span>
<span class="nc" id="L212">			UI.getCurrent().addWindow(getSubwindow(new Booking()));</span>
<span class="nc" id="L213">		});</span>

<span class="fc" id="L215">		editBookingButton.addClickListener(event -&gt; {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">			if (canEditBooking(selectedBookingRecord)) {</span>
<span class="nc" id="L217">				getUI();</span>
<span class="nc" id="L218">				UI.getCurrent().addWindow(getSubwindow(selectedBookingRecord));</span>
			}
<span class="nc" id="L220">		});</span>
<span class="fc" id="L221">	}</span>

	/**
	 * Check whether a customer offering is editable or not based on start date and
	 * current date
	 * 
	 * @param booking
	 *            The booking to check
	 * @return Whether the booking is editable
	 */
	public boolean canEditBooking(Booking booking) {
<span class="fc bfc" id="L232" title="All 2 branches covered.">		if (booking == null)</span>
<span class="fc" id="L233">			return false;</span>

<span class="fc" id="L235">		Date today = Date.from(Instant.now());</span>
<span class="fc" id="L236">		Date threeDayBeforeStart = booking.getOffering().getLastEditableDate();</span>

<span class="fc bfc" id="L238" title="All 2 branches covered.">		if (today.after(threeDayBeforeStart)) {</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">			if (Page.getCurrent() != null) // can be null if using mockito</span>
<span class="nc" id="L240">				NotificationFactory.getTopBarWarningNotification(</span>
						&quot;It's too late to edit this booking. The offering status was finalized on &quot;
<span class="nc" id="L242">								+ Utils.simpleDateFormat(threeDayBeforeStart),</span>
<span class="nc" id="L243">						5).show(Page.getCurrent());</span>

<span class="fc" id="L245">			return false;</span>
		}
<span class="fc" id="L247">		return true;</span>
	}

	/**
	 * Creates the popup window for creating/editing bookings
	 * 
	 * @param bookingToSave
	 *            The transient or detached booking record to save
	 * @return The window
	 */
	public Window getSubwindow(Booking bookingToSave) {
		Window subwindow;

		// Creating the confirm button
<span class="fc" id="L261">		confirmButton = new Button(&quot;Confirm&quot;);</span>
<span class="fc" id="L262">		confirmButton.setId(&quot;confirm_booking&quot;);</span>

<span class="fc" id="L264">		customer = new ComboBox&lt;Customer&gt;(&quot;Customer&quot;);</span>
<span class="fc" id="L265">		offering = new ComboBox&lt;Offering&gt;(&quot;Offering&quot;);</span>
<span class="fc" id="L266">		numberAdults = new TextField(&quot;Number of adults&quot;);</span>
<span class="fc" id="L267">		numberChildren = new TextField(&quot;Number of children&quot;);</span>
<span class="fc" id="L268">		numberToddlers = new TextField(&quot;Number of toddlers&quot;);</span>
<span class="fc" id="L269">		amountPaid = new TextField(&quot;Amount Paid&quot;);</span>
<span class="fc" id="L270">		specialRequest = new TextField(&quot;Special Request&quot;);</span>
<span class="fc" id="L271">		paymentStatus = new ComboBox&lt;&gt;(&quot;Payment Status&quot;);</span>
<span class="fc" id="L272">		promoCode = new ComboBox&lt;&gt;(&quot;Promotion Code&quot;);</span>

<span class="fc" id="L274">		customer.setId(&quot;cb_customer&quot;);</span>
<span class="fc" id="L275">		offering.setId(&quot;cb_offering&quot;);</span>
<span class="fc" id="L276">		numberAdults.setId(&quot;tf_number_of_adults&quot;);</span>
<span class="fc" id="L277">		numberChildren.setId(&quot;tf_number_of_children&quot;);</span>
<span class="fc" id="L278">		numberToddlers.setId(&quot;tf_number_of_toddlers&quot;);</span>
<span class="fc" id="L279">		amountPaid.setId(&quot;tf_amount_paid&quot;);</span>
<span class="fc" id="L280">		specialRequest.setId(&quot;tf_special_request&quot;);</span>
<span class="fc" id="L281">		paymentStatus.setId(&quot;cb_payment_status&quot;);</span>
<span class="fc" id="L282">		promoCode.setId(&quot;cb_promotion_code&quot;);</span>

<span class="fc" id="L284">		customer.setPopupWidth(null); // so that the entire text row can be seen</span>
<span class="fc" id="L285">		offering.setPopupWidth(null);</span>
<span class="fc" id="L286">		paymentStatus.setPopupWidth(null);</span>
<span class="fc" id="L287">		promoCode.setPopupWidth(null);</span>

<span class="fc bfc" id="L289" title="All 2 branches covered.">		if (bookingToSave.getId() == null) { // passed in an unsaved object</span>
<span class="fc" id="L290">			subwindow = new Window(&quot;Create new boooking&quot;);</span>
		} else {
<span class="fc" id="L292">			subwindow = new Window(&quot;Edit a booking&quot;);</span>
		}

<span class="fc" id="L295">		FormLayout form = new FormLayout();</span>
<span class="fc" id="L296">		VerticalLayout formContainer = new VerticalLayout();</span>
<span class="fc" id="L297">		formContainer.addComponent(form);</span>

<span class="fc" id="L299">		subwindow.setWidth(&quot;800px&quot;);</span>
<span class="fc" id="L300">		subwindow.setContent(formContainer);</span>
<span class="fc" id="L301">		subwindow.center();</span>
<span class="fc" id="L302">		subwindow.setClosable(false);</span>
<span class="fc" id="L303">		subwindow.setModal(true);</span>
<span class="fc" id="L304">		subwindow.setResizable(false);</span>
<span class="fc" id="L305">		subwindow.setDraggable(false);</span>

<span class="fc" id="L307">		form.addComponent(customer);</span>
<span class="fc" id="L308">		form.addComponent(offering);</span>
<span class="fc" id="L309">		form.addComponent(numberAdults);</span>
<span class="fc" id="L310">		form.addComponent(numberChildren);</span>
<span class="fc" id="L311">		form.addComponent(numberToddlers);</span>
<span class="fc" id="L312">		form.addComponent(amountPaid);</span>
<span class="fc" id="L313">		form.addComponent(specialRequest);</span>
<span class="fc" id="L314">		form.addComponent(paymentStatus);</span>
<span class="fc" id="L315">		form.addComponent(promoCode);</span>

<span class="fc" id="L317">		offering.addValueChangeListener(event -&gt; {</span>
<span class="fc" id="L318">			Offering o = offering.getValue();</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">			if (o != null) {</span>
<span class="fc" id="L320">				promoCode.setItems(Utils.iterableToCollection(promoRepo.findByOffering(o)).stream()</span>
<span class="pc" id="L321">						.sorted((c1, c2) -&gt; c1.getId().compareTo(c2.getId())).map(PromoEvent::getPromoCode));</span>
<span class="fc" id="L322">				promoCode.setEnabled(true);</span>
			} else {
<span class="fc" id="L324">				promoCode.setEnabled(false);</span>
			}
<span class="fc" id="L326">		});</span>
<span class="fc" id="L327">		promoCode.setEnabled(false);</span>

<span class="fc" id="L329">		HorizontalLayout buttonActions = new HorizontalLayout();</span>
<span class="fc" id="L330">		buttonActions.addComponent(confirmButton);</span>
<span class="pc" id="L331">		buttonActions.addComponent(new Button(&quot;Cancel&quot;, event -&gt; subwindow.close()));</span>
<span class="fc" id="L332">		form.addComponent(buttonActions);</span>

<span class="pc bpc" id="L334" title="1 of 2 branches missed.">		if (customerRepo.findAll() != null) // can be null if mockito</span>
<span class="nc" id="L335">			customer.setItems(Utils.iterableToCollection(customerRepo.findAll()).stream()</span>
<span class="nc" id="L336">					.sorted((c1, c2) -&gt; c1.getId().compareTo(c2.getId())));</span>

<span class="pc bpc" id="L338" title="1 of 2 branches missed.">		if (offeringRepo.findAll() != null) // mockito</span>
<span class="nc" id="L339">			offering.setItems(Utils.iterableToCollection(offeringRepo.findAll()).stream()</span>
<span class="nc" id="L340">					.sorted((o1, o2) -&gt; o1.getId().compareTo(o2.getId())));</span>

<span class="fc" id="L342">		Collection&lt;String&gt; potentialPaymentStatus = new ArrayList&lt;&gt;(</span>
<span class="fc" id="L343">				Arrays.asList(Booking.PAYMENT_PENDING, Booking.PAYMENT_CONFIRMED));</span>
<span class="fc" id="L344">		paymentStatus.setItems(potentialPaymentStatus);</span>
<span class="fc" id="L345">		paymentStatus.setSelectedItem(Booking.PAYMENT_PENDING);</span>

<span class="fc" id="L347">		Binder&lt;Booking&gt; binder = new Binder&lt;Booking&gt;();</span>

<span class="fc" id="L349">		binder.forField(customer).asRequired(Utils.generateRequiredError()).bind(Booking::getCustomer,</span>
				Booking::setCustomer);

<span class="fc" id="L352">		binder.forField(offering).asRequired(Utils.generateRequiredError())</span>
<span class="fc" id="L353">				.withValidator(ValidatorFactory.getOfferingStillOpenValidator())</span>
<span class="fc" id="L354">				.bind(Booking::getOffering, Booking::setOffering);</span>

<span class="fc" id="L356">		binder.forField(numberAdults).asRequired(Utils.generateRequiredError())</span>
<span class="fc" id="L357">				.withConverter(ConverterFactory.getStringToIntegerConverter())</span>
<span class="fc" id="L358">				.withValidator(ValidatorFactory.getIntegerRangeValidator(0))</span>
<span class="fc" id="L359">				.bind(Booking::getNumAdults, Booking::setNumAdults);</span>

<span class="fc" id="L361">		binder.forField(numberChildren).asRequired(Utils.generateRequiredError())</span>
<span class="fc" id="L362">				.withConverter(ConverterFactory.getStringToIntegerConverter())</span>
<span class="fc" id="L363">				.withValidator(ValidatorFactory.getIntegerRangeValidator(0))</span>
<span class="fc" id="L364">				.bind(Booking::getNumChildren, Booking::setNumChildren);</span>

<span class="fc" id="L366">		binder.forField(numberToddlers).asRequired(Utils.generateRequiredError())</span>
<span class="fc" id="L367">				.withConverter(ConverterFactory.getStringToIntegerConverter())</span>
<span class="fc" id="L368">				.withValidator(ValidatorFactory.getIntegerRangeValidator(0))</span>
<span class="fc" id="L369">				.bind(Booking::getNumToddlers, Booking::setNumToddlers);</span>

<span class="fc" id="L371">		binder.forField(amountPaid).asRequired(Utils.generateRequiredError())</span>
<span class="fc" id="L372">				.withConverter(ConverterFactory.getStringToDoubleConverter())</span>
<span class="fc" id="L373">				.withValidator(ValidatorFactory.getDoubleRangeValidator(0))</span>
<span class="fc" id="L374">				.bind(Booking::getAmountPaid, Booking::setAmountPaid);</span>

<span class="fc" id="L376">		binder.forField(specialRequest).withValidator(ValidatorFactory.getStringLengthValidator(255))</span>
<span class="fc" id="L377">				.bind(Booking::getSpecialRequests, Booking::setSpecialRequests);</span>

<span class="fc" id="L379">		binder.forField(paymentStatus).asRequired(Utils.generateRequiredError())</span>
<span class="fc" id="L380">				.withValidator(ValidatorFactory.getStringLengthValidator(255))</span>
<span class="fc" id="L381">				.bind(Booking::getPaymentStatus, Booking::setPaymentStatus);</span>

<span class="fc" id="L383">		binder.forField(promoCode).withValidator(ValidatorFactory.getStringLengthCanNullValidator(255))</span>
<span class="fc" id="L384">				.bind(Booking::getPromoCodeUsed, Booking::setPromoCodeUsed);</span>

<span class="fc" id="L386">		binder.setBean(bookingToSave);</span>

<span class="fc" id="L388">		confirmButton.addClickListener(event -&gt; {</span>
<span class="fc" id="L389">			validationStatus = binder.validate();</span>

<span class="fc" id="L391">			String errors = ValidatorFactory.getValidatorErrorsString(validationStatus);</span>

<span class="fc bfc" id="L393" title="All 2 branches covered.">			if (validationStatus.isOk()) {</span>
<span class="fc" id="L394">				binder.writeBeanIfValid(bookingToSave);</span>

<span class="fc" id="L396">				log.info(&quot;About to save booking [{}]&quot;, bookingToSave);</span>

				try {
<span class="pc bpc" id="L399" title="3 of 4 branches missed.">					if (promoCode.getValue() != null &amp;&amp; !promoCode.isEmpty()) {</span>
						// With promo code
<span class="nc" id="L401">						dbManager.createBookingForOfferingWithPromoCode(bookingToSave, promoCode.getValue());</span>
<span class="nc" id="L402">						log.info(&quot;Saved a new booking [{}] with promo code [{}] successfully&quot;, bookingToSave,</span>
<span class="nc" id="L403">								promoCode.getValue());</span>
					} else {
						// Without promo code
<span class="fc" id="L406">						dbManager.createNormalBookingForOffering(bookingToSave);</span>
<span class="fc" id="L407">						log.info(&quot;Saved a new booking [{}] successfully&quot;, bookingToSave);</span>
					}
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">					if (bookingToSave.getId() == null) {</span>
<span class="nc" id="L410">						bookingRepo.delete(bookingToSave);</span>
					}
<span class="fc" id="L412">					binder.removeBean();</span>
<span class="fc" id="L413">					this.refreshData();</span>
<span class="fc" id="L414">					subwindow.close();</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">					if (Page.getCurrent() != null) // can be null if using mockito</span>
<span class="nc" id="L416">						NotificationFactory.getTopBarSuccessNotification().show(Page.getCurrent());</span>
<span class="nc" id="L417">				} catch (PromoForCustomerExceededException e) {</span>
<span class="nc" id="L418">					errors += &quot;The customer has exceeded the maximum number of reserations allowed.\n&quot;;</span>
<span class="nc" id="L419">				} catch (PromoCodeUsedUpException e) {</span>
<span class="nc" id="L420">					errors += &quot;The promo code has been used up.\n&quot;;</span>
<span class="nc" id="L421">				} catch (NoSuchPromoCodeException e) {</span>
<span class="nc" id="L422">					errors += &quot;The promo code does not exist.\n&quot;;</span>
<span class="nc" id="L423">				} catch (OfferingOutOfRoomException e) {</span>
<span class="nc" id="L424">					errors += &quot;Not enough room in offering&quot;;</span>
<span class="nc" id="L425">				} catch (PromoCodeNotForOfferingException e) {</span>
<span class="nc" id="L426">					errors += &quot;The promo code is not for this offering.\n&quot;;</span>
<span class="pc" id="L427">				}</span>
			}

<span class="pc bpc" id="L430" title="1 of 4 branches missed.">			if (!errors.isEmpty() &amp;&amp; Page.getCurrent() != null) {</span>
<span class="nc" id="L431">				NotificationFactory.getTopBarWarningNotification(errors, 5).show(Page.getCurrent());</span>
			}
<span class="fc" id="L433">		});</span>

<span class="fc" id="L435">		return subwindow;</span>
	}

	/**
	 * Refreshes the data in the vaadin grid
	 */
	public void refreshData() {
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">		if (bookingRepo.findAll() != null) { // mockito</span>
<span class="nc" id="L443">			ListDataProvider&lt;Booking&gt; provider = new ListDataProvider&lt;&gt;(</span>
<span class="nc" id="L444">					Utils.iterableToCollection(bookingRepo.findAll()));</span>
<span class="nc" id="L445">			bookingGrid.setDataProvider(provider);</span>
		}
<span class="fc" id="L447">	}</span>

	/**
	 * @return the customer field
	 */
	public ComboBox&lt;Customer&gt; getCustomer() {
<span class="fc" id="L453">		return customer;</span>
	}

	/**
	 * @return the offering field
	 */
	public ComboBox&lt;Offering&gt; getOffering() {
<span class="fc" id="L460">		return offering;</span>
	}

	/**
	 * @return the numberAdults field
	 */
	public TextField getNumberAdults() {
<span class="fc" id="L467">		return numberAdults;</span>
	}

	/**
	 * @return the numberChildren field
	 */
	public TextField getNumberChildren() {
<span class="fc" id="L474">		return numberChildren;</span>
	}

	/**
	 * @return the numberToddlers field
	 */
	public TextField getNumberToddlers() {
<span class="fc" id="L481">		return numberToddlers;</span>
	}

	/**
	 * @return the amountPaid field
	 */
	public TextField getAmountPaid() {
<span class="fc" id="L488">		return amountPaid;</span>
	}

	/**
	 * @return the specialRequest field
	 */
	public TextField getSpecialRequest() {
<span class="fc" id="L495">		return specialRequest;</span>
	}

	/**
	 * @return the paymentStatus field
	 */
	public ComboBox&lt;String&gt; getPaymentStatus() {
<span class="fc" id="L502">		return paymentStatus;</span>
	}

	/**
	 * @return the promoCode field
	 */
	public ComboBox&lt;String&gt; getPromoCode() {
<span class="fc" id="L509">		return promoCode;</span>
	}

	/**
	 * @return the confirmButton
	 */
	public Button getConfirmButton() {
<span class="fc" id="L516">		return confirmButton;</span>
	}

	/**
	 * @return the validationStatus object
	 */
	public BinderValidationStatus&lt;Booking&gt; getValidationStatus() {
<span class="fc" id="L523">		return validationStatus;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>